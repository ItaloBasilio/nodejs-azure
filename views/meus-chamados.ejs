<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Service Desk - Meus Chamados</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body { background-color: #f8f9fa; }

        .sidebar { height: 100vh; background-color: #212529; }

        .sidebar a {
            color: #adb5bd;
            text-decoration: none;
            display: block;
            padding: 10px;
        }

        .sidebar a:hover { background-color: #343a40; color: #fff; }

        .sidebar .active { background-color: #343a40; color: #fff; }

        .card-dashboard { border-left: 5px solid #0d6efd; }

        .titulo-link { text-decoration: none; font-weight: 500; }
        .titulo-link:hover { text-decoration: underline; }

        .filter-hint { font-size: .9rem; }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/"><i class="bi bi-headset"></i> Service Desk</a>
            <div class="d-flex">
                <span id="userName" class="navbar-text text-white me-3">Bem-vindo</span>
                <button id="logoutBtn" class="btn btn-outline-light btn-sm">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">

            <!-- ✅ MENU (partial) -->
            <%- include("partials/sidebar") %>

            <div class="col-md-10 p-4">

                <!-- Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card card-dashboard shadow-sm">
                            <div class="card-body">
                                <h6>Chamados Abertos</h6>
                                <h3 id="cardAbertos">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success shadow-sm">
                            <div class="card-body">
                                <h6>Resolvidos</h6>
                                <h3 id="cardResolvidos">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning shadow-sm">
                            <div class="card-body">
                                <h6>Em Atendimento</h6>
                                <h3 id="cardAtendimento">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-danger shadow-sm">
                            <div class="card-body">
                                <h6>Críticos</h6>
                                <h3 id="cardCriticos">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        Meus Chamados
                    </div>
                    <div class="card-body">

                        <!-- ✅ FILTRO -->
                        <div class="row g-2 align-items-end mb-3">
                            <div class="col-md-6">
                                <label class="form-label mb-1">Pesquisar</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="filtroChamados"
                                        placeholder="Digite ID, título, cliente, solicitante, status ou prioridade..."
                                        autocomplete="off"
                                    >
                                    <button class="btn btn-outline-secondary" type="button" id="btnLimparFiltroChamados">
                                        Limpar
                                    </button>
                                </div>
                                <div class="text-muted filter-hint mt-1">
                                    Busca em: <strong>ID</strong>, <strong>Título</strong>, <strong>Cliente</strong>, <strong>Solicitante</strong>, <strong>Status</strong>, <strong>Prioridade</strong>
                                </div>
                            </div>

                            <div class="col-md-6 text-md-end">
                                <div class="text-muted">
                                    <span id="contadorChamados">0</span> resultado(s)
                                </div>
                            </div>
                        </div>

                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Título</th>
                                    <!-- ✅ NOVO: Cliente -->
                                    <th>Cliente</th>
                                    <th>Solicitante</th>
                                    <th>Status</th>
                                    <th>Prioridade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyChamados">
                                <tr>
                                    <td colspan="7" class="text-muted">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ✅ AUTH HELPER (JWT) -->
    <script src="/js/auth.js"></script>

    <script>
        const API = "/api/chamados/meus";

        function marcarMenuAtivo() {
            const path = window.location.pathname;
            document.querySelectorAll(".sidebar a").forEach(a => {
                const href = a.getAttribute("href");
                if (href === path) a.classList.add("active");
            });
        }

        async function verificarLoginLocal() {
            const token = getToken();
            if (!token) {
                window.location.href = "/login";
                return false;
            }

            const response = await authFetch("/api/auth/check");
            if (!response.ok) {
                localStorage.removeItem("token");
                window.location.href = "/login";
                return false;
            }

            return true;
        }

        function badgeStatus(status) {
            if (status === "Aberto") return "bg-warning";
            if (status === "Resolvido") return "bg-success";
            if (status === "Em Atendimento") return "bg-primary";
            return "bg-secondary";
        }

        function badgePrioridade(prioridade) {
            if (prioridade === "Crítica") return "bg-danger";
            if (prioridade === "Alta") return "bg-danger";
            if (prioridade === "Média") return "bg-warning";
            return "bg-secondary";
        }

        function normalizarTexto(s) {
            return (s || "")
                .toString()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase()
                .trim();
        }

        // ✅ mantém só o nome do cliente (remove CNPJ se vier junto)
        function extrairNomeCliente(cliente) {
            const s = (cliente || "").toString().trim();
            if (!s) return "-";

            // Ex: "Empresa XYZ - 12.345.678/0001-90" ou "Empresa XYZ | 12.345..."
            const partes = s.split(/\s*[-|–—]\s*|\s*\|\s*/);
            const nome = (partes[0] || "").trim();

            return nome || s;
        }

        function aplicarFiltroChamados() {
            const input = document.getElementById("filtroChamados");
            const termo = normalizarTexto(input?.value || "");
            const tbody = document.getElementById("tbodyChamados");
            const contador = document.getElementById("contadorChamados");
            if (!tbody) return;

            const linhas = Array.from(tbody.querySelectorAll("tr[data-search]"));
            if (!linhas.length) {
                if (contador) contador.innerText = "0";
                return;
            }

            let visiveis = 0;
            linhas.forEach(tr => {
                const hay = tr.getAttribute("data-search") || "";
                const match = !termo || hay.includes(termo);
                tr.classList.toggle("d-none", !match);
                if (match) visiveis++;
            });

            if (contador) contador.innerText = String(visiveis);

            const avisoId = "linhaSemResultadosChamados";
            let aviso = document.getElementById(avisoId);
            if (!visiveis) {
                if (!aviso) {
                    aviso = document.createElement("tr");
                    aviso.id = avisoId;
                    aviso.innerHTML = `<td colspan="7" class="text-muted">Nenhum chamado encontrado para o filtro atual.</td>`;
                    tbody.appendChild(aviso);
                } else {
                    aviso.classList.remove("d-none");
                }
            } else {
                if (aviso) aviso.classList.add("d-none");
            }
        }

        function prepararFiltroChamados() {
            const input = document.getElementById("filtroChamados");
            const btnLimpar = document.getElementById("btnLimparFiltroChamados");
            if (!input || !btnLimpar) return;

            input.addEventListener("input", aplicarFiltroChamados);
            btnLimpar.addEventListener("click", () => {
                input.value = "";
                input.focus();
                aplicarFiltroChamados();
            });
        }

        async function carregarChamados() {
            const response = await authFetch(API);

            const tbody = document.getElementById("tbodyChamados");
            const contador = document.getElementById("contadorChamados");

            if (!response.ok) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-danger">
                            Erro ao carregar seus chamados (${response.status}).
                        </td>
                    </tr>
                `;
                if (contador) contador.innerText = "0";
                return;
            }

            let chamados = await response.json();
            chamados.sort((a, b) => Number(b.id) - Number(a.id));

            tbody.innerHTML = "";

            let abertos = 0, resolvidos = 0, atendimento = 0, criticos = 0;

            if (!chamados || chamados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-muted">
                            Você ainda não abriu nenhum chamado.
                        </td>
                    </tr>
                `;

                document.getElementById("cardAbertos").innerText = 0;
                document.getElementById("cardResolvidos").innerText = 0;
                document.getElementById("cardAtendimento").innerText = 0;
                document.getElementById("cardCriticos").innerText = 0;

                if (contador) contador.innerText = "0";
                return;
            }

            chamados.forEach(chamado => {

                if (chamado.status === "Aberto") abertos++;
                if (chamado.status === "Resolvido") resolvidos++;
                if (chamado.status === "Em Atendimento") atendimento++;
                if (chamado.prioridade === "Crítica") criticos++;

                const clienteNome = extrairNomeCliente(chamado.cliente);
                const search = normalizarTexto(
                    `${chamado.id} ${chamado.titulo} ${clienteNome} ${chamado.solicitante} ${chamado.status} ${chamado.prioridade}`
                );

                const row = document.createElement("tr");
                row.setAttribute("data-search", search);

                row.innerHTML = `
                    <td>${chamado.id}</td>
                    <td>
                        <a href="/chamados/${chamado.id}" class="titulo-link text-dark">
                            ${chamado.titulo}
                        </a>
                    </td>

                    <!-- ✅ NOVO: Cliente -->
                    <td>${clienteNome}</td>

                    <td>${chamado.solicitante}</td>
                    <td><span class="badge ${badgeStatus(chamado.status)}">${chamado.status}</span></td>
                    <td><span class="badge ${badgePrioridade(chamado.prioridade)}">${chamado.prioridade}</span></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="resolverChamado('${chamado.id}')">
                            <i class="bi bi-check"></i>
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });

            document.getElementById("cardAbertos").innerText = abertos;
            document.getElementById("cardResolvidos").innerText = resolvidos;
            document.getElementById("cardAtendimento").innerText = atendimento;
            document.getElementById("cardCriticos").innerText = criticos;

            if (contador) contador.innerText = String(chamados.length);

            aplicarFiltroChamados();
        }

        async function resolverChamado(id) {
            await authFetch("/api/chamados/" + id, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: "Resolvido" })
            });

            carregarChamados();
        }

        document.getElementById("logoutBtn").addEventListener("click", () => {
            logout();
        });

        async function iniciar() {
            marcarMenuAtivo();

            prepararFiltroChamados();

            const ok = await verificarLoginLocal();
            if (!ok) return;

            await carregarUsuarioLogado();
            await carregarChamados();
        }

        iniciar();
    </script>

</body>
</html>