<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Service Desk - Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body { background-color: #f8f9fa; }
        .sidebar { height: 100vh; background-color: #212529; }
        .sidebar a {
            color: #adb5bd;
            text-decoration: none;
            display: block;
            padding: 10px;
        }
        .sidebar a:hover { background-color: #343a40; color: #fff; }
        .card-dashboard { border-left: 5px solid #0d6efd; }
    </style>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/"><i class="bi bi-headset"></i> Service Desk</a>
        <div class="d-flex">
            <span id="userName" class="navbar-text text-white me-3">Bem-vindo</span>
            <button id="logoutBtn" class="btn btn-outline-light btn-sm">Sair</button>
        </div>
    </div>
</nav>

<div class="container-fluid">
<div class="row">

    <!-- ✅ MENU (partial) -->
    <%- include("partials/sidebar") %>

    <div class="col-md-10 p-4">

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-dashboard shadow-sm">
                    <div class="card-body">
                        <h6>Chamados Abertos</h6>
                        <h3 id="cardAbertos">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success shadow-sm">
                    <div class="card-body">
                        <h6>Resolvidos</h6>
                        <h3 id="cardResolvidos">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning shadow-sm">
                    <div class="card-body">
                        <h6>Em Atendimento</h6>
                        <h3 id="cardAtendimento">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-danger shadow-sm">
                    <div class="card-body">
                        <h6>Críticos</h6>
                        <h3 id="cardCriticos">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                Últimos Chamados
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Título</th>
                        <th>Usuário</th>
                        <th>Status</th>
                        <th>Prioridade</th>
                    </tr>
                    </thead>
                    <tbody id="tabelaUltimos"></tbody>
                </table>
            </div>
        </div>

    </div>
</div>
</div>

<!-- ✅ JWT helper -->
<script src="/js/auth.js"></script>

<script>
const API = "/api/chamados";

function badgeStatus(s) {
    if (s === "Aberto") return "bg-warning";
    if (s === "Resolvido") return "bg-success";
    if (s === "Em Atendimento") return "bg-primary";
    return "bg-secondary";
}

function badgePrioridade(p) {
    if (p === "Crítica" || p === "Alta") return "bg-danger";
    if (p === "Média") return "bg-warning";
    return "bg-secondary";
}

async function carregarChamados() {
    const res = await authFetch(API);
    if (!res.ok) {
        console.error("Erro ao carregar chamados:", res.status);
        return;
    }

    const chamados = await res.json();

    let a=0,r=0,e=0,c=0;
    chamados.forEach(ch=>{
        if(ch.status==="Aberto") a++;
        if(ch.status==="Resolvido") r++;
        if(ch.status==="Em Atendimento") e++;
        if(ch.prioridade==="Crítica") c++;
    });

    cardAbertos.innerText=a;
    cardResolvidos.innerText=r;
    cardAtendimento.innerText=e;
    cardCriticos.innerText=c;

    chamados.sort((x,y)=>Number(y.id)-Number(x.id));
    const ultimos = chamados.slice(0,3);

    tabelaUltimos.innerHTML="";
    ultimos.forEach(ch=>{
        tabelaUltimos.innerHTML += `
        <tr>
            <td>${ch.id}</td>
            <td>${ch.titulo}</td>
            <td>${ch.solicitante}</td>
            <td><span class="badge ${badgeStatus(ch.status)}">${ch.status}</span></td>
            <td><span class="badge ${badgePrioridade(ch.prioridade)}">${ch.prioridade}</span></td>
        </tr>`;
    });
}

logoutBtn.onclick = logout;

(async function iniciar(){
    const ok = await verificarLogin();
    if(!ok) return;

    await carregarUsuarioLogado();
    await carregarChamados();
})();
</script>

</body>
</html>