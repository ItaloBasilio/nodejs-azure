<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Service Desk - Usuários</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body { background-color: #f8f9fa; }

        .sidebar { height: 100vh; background-color: #212529; }
        .sidebar a {
            color: #adb5bd;
            text-decoration: none;
            display: block;
            padding: 10px;
        }
        .sidebar a:hover { background-color: #343a40; color: #fff; }
        .sidebar .active { background-color: #343a40; color: #fff; }

        .titulo-link { text-decoration: none; font-weight: 500; }
        .titulo-link:hover { text-decoration: underline; }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/"><i class="bi bi-headset"></i> Service Desk</a>
            <div class="d-flex">
                <span id="userName" class="navbar-text text-white me-3">Bem-vindo</span>
                <button id="logoutBtn" class="btn btn-outline-light btn-sm">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">

            <!-- MENU -->
            <div class="col-md-2 sidebar p-3">
                <h6 class="text-white">Menu</h6>
                <a href="/"><i class="bi bi-speedometer2"></i> Dashboard</a>
                <a href="/chamados"><i class="bi bi-ticket"></i> Chamados</a>
                <a href="/novo-chamado"><i class="bi bi-plus-circle"></i> Novo Chamado</a>
                <a href="/usuarios" class="active"><i class="bi bi-people"></i> Criar Usuário</a>
            </div>

            <!-- CONTEÚDO -->
            <div class="col-md-10 p-4">

                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h3 class="m-0">Usuários</h3>
                    <small class="text-muted">Acesso restrito: Admin</small>
                </div>

                <!-- ALERTAS -->
                <div id="alertSuccess" class="alert alert-success d-none" role="alert"></div>
                <div id="alertError" class="alert alert-danger d-none" role="alert"></div>

                <!-- CARD CRIAR USUÁRIO -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        Criar novo usuário
                    </div>
                    <div class="card-body">

                        <form id="formCriarUsuario" autocomplete="off">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Nome</label>
                                    <input type="text" class="form-control" id="nome" required>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Usuário (login)</label>
                                    <input type="text" class="form-control" id="usuario" required>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Senha</label>
                                    <input type="password" class="form-control" id="senha" required>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Role</label>
                                    <select class="form-select" id="role" required>
                                        <option value="analista">Analista</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>

                                <div class="col-12">
                                    <button class="btn btn-success" type="submit">
                                        <i class="bi bi-person-plus"></i> Criar Usuário
                                    </button>
                                </div>
                            </div>
                        </form>

                        <hr class="my-4">

                        <small class="text-muted">
                            Dica: use login simples (ex: <strong>joao</strong>) e defina role <strong>analista</strong> para limitar permissões.
                        </small>
                    </div>
                </div>

                <!-- LISTA DE USUÁRIOS -->
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white">
                        Lista de usuários
                    </div>

                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nome</th>
                                        <th>Usuário</th>
                                        <th>Role</th>
                                        <th style="width: 220px;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyUsuarios">
                                    <tr>
                                        <td colspan="5" class="text-muted">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <small class="text-muted">
                            * “Alterar senha” já está pronto no front. Falta apenas existir o endpoint no back.
                        </small>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL: ALTERAR SENHA -->
    <div class="modal fade" id="modalSenha" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formAlterarSenha">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-key"></i> Alterar senha</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="senhaUserId">
                        <div class="mb-3">
                            <label class="form-label">Usuário</label>
                            <input type="text" class="form-control" id="senhaUsuarioLabel" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nova senha</label>
                            <input type="password" class="form-control" id="novaSenha" required>
                        </div>
                        <div class="alert alert-warning small mb-0">
                            A senha antiga será substituída.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ✅ AUTH HELPER (JWT) -->
    <script src="/js/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_USUARIOS = "/api/usuarios";
        const modalSenhaEl = document.getElementById("modalSenha");
        const modalSenha = new bootstrap.Modal(modalSenhaEl);

        function showSuccess(msg) {
            const el = document.getElementById("alertSuccess");
            el.innerText = msg;
            el.classList.remove("d-none");
            setTimeout(() => el.classList.add("d-none"), 3000);
        }

        function showError(msg) {
            const el = document.getElementById("alertError");
            el.innerText = msg;
            el.classList.remove("d-none");
            setTimeout(() => el.classList.add("d-none"), 4500);
        }

        async function exigirAdmin() {
            const ok = await verificarLogin();
            if (!ok) return false;

            const res = await authFetch("/api/auth/check");
            if (!res.ok) {
                window.location.href = "/login";
                return false;
            }

            const data = await res.json();
            if (data?.usuario?.role !== "admin") {
                window.location.href = "/";
                return false;
            }

            return true;
        }

        function badgeRole(role) {
            if (role === "admin") return "bg-danger";
            return "bg-secondary";
        }

        async function carregarUsuarios() {
            const tbody = document.getElementById("tbodyUsuarios");
            tbody.innerHTML = `<tr><td colspan="5" class="text-muted">Carregando...</td></tr>`;

            const res = await authFetch(API_USUARIOS);

            if (!res.ok) {
                const txt = await res.text().catch(() => "");
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-danger">
                            Erro ao carregar usuários (${res.status}). ${txt ? "Detalhe: " + txt : ""}
                        </td>
                    </tr>`;
                return;
            }

            const usuarios = await res.json().catch(() => []);

            if (!usuarios || usuarios.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-muted">Nenhum usuário cadastrado.</td></tr>`;
                return;
            }

            tbody.innerHTML = "";
            usuarios.forEach(u => {
                tbody.innerHTML += `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.nome}</td>
                        <td>${u.usuario}</td>
                        <td><span class="badge ${badgeRole(u.role)}">${u.role}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" type="button"
                                onclick="abrirModalSenha('${u.id}', '${u.usuario}')">
                                <i class="bi bi-key"></i> Alterar senha
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        window.abrirModalSenha = function(id, usuario) {
            document.getElementById("senhaUserId").value = id;
            document.getElementById("senhaUsuarioLabel").value = usuario;
            document.getElementById("novaSenha").value = "";
            modalSenha.show();
        }

        document.getElementById("formCriarUsuario").addEventListener("submit", async (e) => {
            e.preventDefault();

            const nome = document.getElementById("nome").value.trim();
            const usuario = document.getElementById("usuario").value.trim();
            const senha = document.getElementById("senha").value;
            const role = document.getElementById("role").value;

            if (!nome || !usuario || !senha || !role) {
                showError("Preencha todos os campos.");
                return;
            }

            const res = await authFetch(API_USUARIOS, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nome, usuario, senha, role })
            });

            const data = await res.json().catch(() => null);

            if (!res.ok) {
                showError(data?.error || data?.message || "Erro ao criar usuário.");
                return;
            }

            showSuccess("Usuário criado com sucesso!");
            document.getElementById("formCriarUsuario").reset();
            carregarUsuarios();
        });

        document.getElementById("formAlterarSenha").addEventListener("submit", async (e) => {
            e.preventDefault();

            const id = document.getElementById("senhaUserId").value;
            const novaSenha = document.getElementById("novaSenha").value;

            if (!id || !novaSenha) {
                showError("Informe a nova senha.");
                return;
            }

            const res = await authFetch(`${API_USUARIOS}/${id}/senha`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ senha: novaSenha })
            });

            const data = await res.json().catch(() => null);

            if (!res.ok) {
                showError(data?.error || data?.message || "Erro ao alterar senha.");
                return;
            }

            modalSenha.hide();
            showSuccess("Senha alterada com sucesso!");
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            logout();
        });

        async function iniciar() {
            const ok = await exigirAdmin();
            if (!ok) return;

            await carregarUsuarioLogado();
            await carregarUsuarios();
        }

        iniciar();
    </script>

</body>
</html>